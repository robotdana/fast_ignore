#!/usr/bin/env ruby --disable-all
# frozen_string_literal: true

print "require 'path_list':      "
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
require_relative '../lib/path_list'
finish = Process.clock_gettime(Process::CLOCK_MONOTONIC)
puts (finish - start).to_s

print 'fresh PathList.gitignore:  '
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
path_list = PathList.gitignore
new_a = path_list.to_a
finish = Process.clock_gettime(Process::CLOCK_MONOTONIC)
puts (finish - start).to_s

print 'git ls-files:               '
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
git_a = `git -c "core.quotepath=off" ls-files --recurse-submodules`.split("\n")
finish = Process.clock_gettime(Process::CLOCK_MONOTONIC)
puts (finish - start).to_s

# take into account indexed ignored things
files_in_the_index_that_would_be_ignored = `git ls-files -ic --exclude-standard`.split("\n")
files_in_the_index_that_are_deleted = `git diff --no-renames --diff-filter=D --name-only`.split("\n")
untracked_files = `git ls-files --others --exclude-standard`.split("\n")

ignored_by_path_list_not_by_git = (
  git_a.map(&:downcase) -
  new_a.map(&:downcase) -
  files_in_the_index_that_would_be_ignored.map(&:downcase) -
  files_in_the_index_that_are_deleted.map(&:downcase)
)
ignored_by_git_not_by_path_list = (
  new_a.map(&:downcase) -
  git_a.map(&:downcase) -
  untracked_files.map(&:downcase)
)
exit_status = 0

unless ignored_by_path_list_not_by_git.empty?
  puts "\e[31mIgnored by PathList, not by git:\e[0m"
  ignored_by_path_list_not_by_git.map { |f| puts f }
  exit_status = 1
end

unless ignored_by_git_not_by_path_list.empty?
  puts "\e[31mIgnored by git, not by PathList:\e[0m"
  ignored_by_git_not_by_path_list.map { |f| puts f }
  exit_status = 1
end

exit exit_status
