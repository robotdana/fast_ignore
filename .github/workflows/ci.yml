name: CI

on: [push, pull_request]

jobs:
  rspec:
    strategy:
      fail-fast: false
      matrix:
        ruby: [2.7, '3.0', 3.1, 3.2, ruby-head, jruby-9.4, jruby-head]
        platform: [ubuntu, windows, macos]
    continue-on-error: ${{ endsWith(matrix.ruby, 'head') }}
    runs-on: ${{matrix.platform}}-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
    - run: gem install syntax_suggest
    - run: bundle exec rspec spec --dry-run
    - run: bundle exec rspec spec --tag=~gitls

  compare:
    strategy:
      fail-fast: false
      matrix:
        repo:
          - torvalds/linux
          - rails/rails
          - ruby/ruby
          - facebook/react
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - run: ruby -e 'puts ::File.identical?(Dir.pwd, Dir.pwd.swapcase)'
    - run: git clone --depth 1 https://github.com/${{ matrix.repo }}.git target
    - run: cd target && ../bin/compare
      id: compare
    - run: cd target && ../bin/parse
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && ../bin/ls
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && ../bin/ls '*.gitignore' | xargs tail -n +1
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && find *
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files -ic --exclude-standard
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git diff --no-renames --diff-filter=D --name-only
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files --others --exclude-standard
      if: failure() && steps.compare.outcome == 'failure'
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
      - run: gem install syntax_suggest
      - run: COVERAGE=1 bundle exec rspec

      - uses: actions/upload-artifact@v2
        with:
          name: coverage-report
          path: 'coverage/*'
          retention-days: 1
        if: ${{ failure() }}

  rubocop:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - run: gem install syntax_suggest
    - run: bundle exec rubocop

  spellr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - run: gem install syntax_suggest
    - run: bundle exec spellr

  leftovers:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - run: gem install syntax_suggest
    - run: bundle exec leftovers

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - run: gem install syntax_suggest
    - run: bundle exec rake build
